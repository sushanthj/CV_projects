

<!DOCTYPE html>

<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">

  

  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="/assets/css/just-the-docs-default.css">

  

  
    <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>3D_reconstruction | CV projects</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="3D_reconstruction" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Computer Vision projects and assignments during my time in CMU" />
<meta property="og:description" content="Computer Vision projects and assignments during my time in CMU" />
<link rel="canonical" href="http://localhost:4000/3D_reconstruction/" />
<meta property="og:url" content="http://localhost:4000/3D_reconstruction/" />
<meta property="og:site_name" content="CV projects" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="3D_reconstruction" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"Computer Vision projects and assignments during my time in CMU","headline":"3D_reconstruction","url":"http://localhost:4000/3D_reconstruction/"}</script>
<!-- End Jekyll SEO tag -->


  

</head>

<body>
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="svg-link" viewBox="0 0 24 24">
      <title>Link</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
      </svg>
    </symbol>
    <symbol id="svg-search" viewBox="0 0 24 24">
      <title>Search</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
        <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </symbol>
    <symbol id="svg-menu" viewBox="0 0 24 24">
      <title>Menu</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu">
        <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </symbol>
    <symbol id="svg-arrow-right" viewBox="0 0 24 24">
      <title>Expand</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </symbol>
    <symbol id="svg-doc" viewBox="0 0 24 24">
      <title>Document</title>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file">
        <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline>
      </svg>
    </symbol>
  </svg>

  <div class="side-bar">
    <div class="site-header">
      <a href="http://localhost:4000/" class="site-title lh-tight">
  CV projects

</a>
      <a href="#" id="menu-button" class="site-button">
        <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg>
      </a>
    </div>
    <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav">
      
        <ul class="nav-list"><li class="nav-list-item"><a href="http://localhost:4000/" class="nav-list-link">Home</a></li><li class="nav-list-item"><a href="http://localhost:4000/intro/" class="nav-list-link">Intro</a></li><li class="nav-list-item"><a href="http://localhost:4000/numpy/" class="nav-list-link">Numpy</a></li><li class="nav-list-item"><a href="http://localhost:4000/spatial_pyramid_matching/" class="nav-list-link">Spatial Pyramid Matching for Scene Classification</a></li><li class="nav-list-item"><a href="http://localhost:4000/optical_flow/" class="nav-list-link">Optical Flow and Image Alignment</a></li><li class="nav-list-item"><a href="http://localhost:4000/planar_homography/" class="nav-list-link">Planar Homography</a></li><li class="nav-list-item active"><a href="http://localhost:4000/3D_reconstruction/" class="nav-list-link active">3D_reconstruction</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/DL_overview" class="nav-list-link">DL Overview</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/docs/DL_Overview/DL.html" class="nav-list-link">Deep Learning Starter</a></li><li class="nav-list-item "><a href="http://localhost:4000/docs/DL_Overview/DL_old_arches.html" class="nav-list-link">DL Simple Architechtures</a></li><li class="nav-list-item "><a href="http://localhost:4000/docs/DL_Overview/IDL1.html" class="nav-list-link">MLPs (IDL1)</a></li><li class="nav-list-item "><a href="http://localhost:4000/docs/DL_Overview/IDL2.html" class="nav-list-link">Classifiers (IDL2)</a></li><li class="nav-list-item "><a href="http://localhost:4000/docs/DL_Overview/IDL3.html" class="nav-list-link">Optimizers and Regularizers (IDL3)</a></li><li class="nav-list-item "><a href="http://localhost:4000/docs/DL_Overview/IDL4.html" class="nav-list-link">Intro to CNNs</a></li><li class="nav-list-item "><a href="http://localhost:4000/docs/DL_Overview/Resnet.html" class="nav-list-link">RESNET</a></li></ul></li><li class="nav-list-item"><a href="http://localhost:4000/pytorch/" class="nav-list-link">Intro to Pytorch</a></li><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://localhost:4000/docs/SLAM_overview" class="nav-list-link">SLAM</a><ul class="nav-list "><li class="nav-list-item "><a href="http://localhost:4000/docs/SLAM/Probability_review.html" class="nav-list-link">Recap on Probability</a></li><li class="nav-list-item "><a href="http://localhost:4000/docs/SLAM/Expectation_and_cov.html" class="nav-list-link">Expectation and Covariance</a></li></ul></li><li class="nav-list-item"><a href="http://localhost:4000/git_concepts" class="nav-list-link">Git Concepts</a></li></ul>

      
    </nav>
    <footer class="site-footer">
      This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.
    </footer>
  </div>
  <div class="main" id="top">
    <div id="main-header" class="main-header">
      
        <div class="search">
          <div class="search-input-wrap">
            <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search CV projects" aria-label="Search CV projects" autocomplete="off">
            <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label>
          </div>
          <div id="search-results" class="search-results"></div>
        </div>
      
      
      
        <nav aria-label="Auxiliary" class="aux-nav">
          <ul class="aux-nav-list">
            
              <li class="aux-nav-list-item">
                <a href="//github.com/sushanthj" class="site-button"
                  
                >
                  Sushanth's GitHub
                </a>
              </li>
            
          </ul>
        </nav>
      
    </div>
    <div id="main-content-wrap" class="main-content-wrap">
      
        
      
      <div id="main-content" class="main-content" role="main">
        
          <details open="">
  <summary class="text-delta">
    Table of contents
  </summary>
<ol id="markdown-toc">
  <li><a href="#before-you-begin" id="markdown-toc-before-you-begin">Before you Begin</a></li>
  <li><a href="#pdfs" id="markdown-toc-pdfs">PDFs</a></li>
  <li><a href="#estimating-the-rotation-and-translation-between-two-camera-views" id="markdown-toc-estimating-the-rotation-and-translation-between-two-camera-views">Estimating the Rotation and Translation between two camera views</a>    <ol>
      <li><a href="#triangulate3d" id="markdown-toc-triangulate3d">triangulate3D</a></li>
      <li><a href="#findm2" id="markdown-toc-findm2">findM2</a></li>
      <li><a href="#combining-the-above-two-functions" id="markdown-toc-combining-the-above-two-functions">Combining the above two functions</a></li>
    </ol>
  </li>
  <li><a href="#bundle-adjustment" id="markdown-toc-bundle-adjustment">Bundle Adjustment</a>    <ol>
      <li><a href="#high-level-procedure" id="markdown-toc-high-level-procedure">High level procedure</a>        <ol>
          <li><a href="#rodriguesresidual-rodriguesresidualx-k1-m1-p1-k2-p2" id="markdown-toc-rodriguesresidual-rodriguesresidualx-k1-m1-p1-k2-p2">RodriguesResidual: <em>rodriguesResidual(x, K1, M1, p1, K2, p2)</em></a></li>
        </ol>
      </li>
      <li><a href="#optimization-of-m2" id="markdown-toc-optimization-of-m2">Optimization of M2</a></li>
    </ol>
  </li>
</ol>

</details>
      <h2 id="before-you-begin">
        
        
          <a href="#before-you-begin" class="anchor-heading" aria-labelledby="before-you-begin"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Before you Begin
        
        
      </h2>
    

<p><a href="https://drive.google.com/file/d/1jqEB739EfifhSyiCK6vdbPIz7gX9Ywmr/view?usp=sharing" class="btn fs-3 mb-4 mb-md-0">Reference Book 1</a>
<a href="https://drive.google.com/file/d/1Kn6dilDeR_7leIctuVa87-czuqBoxJh-/view?usp=sharing" class="btn fs-3 mb-4 mb-md-0">Reference Book 2</a></p>
      <h2 id="pdfs">
        
        
          <a href="#pdfs" class="anchor-heading" aria-labelledby="pdfs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> PDFs
        
        
      </h2>
    

<p><a href="https://github.com/sushanthj/assignments_F22/blob/main/CV_A/Assignment_4/hw4.pdf" class="btn fs-3 mb-4 mb-md-0">Assignment Questionnaire</a></p>

<p><a href="https://github.com/sushanthj/assignments_F22/blob/main/CV_A/Assignment_4/code/for_sub/sushantj_hw4.pdf" class="btn fs-3 mb-4 mb-md-0">My Answers</a></p>
      <h1 id="estimating-the-rotation-and-translation-between-two-camera-views">
        
        
          <a href="#estimating-the-rotation-and-translation-between-two-camera-views" class="anchor-heading" aria-labelledby="estimating-the-rotation-and-translation-between-two-camera-views"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Estimating the Rotation and Translation between two camera views
        
        
      </h1>
    

<p>Here we are given two images (the two camera views)</p>
      <h2 id="triangulate3d">
        
        
          <a href="#triangulate3d" class="anchor-heading" aria-labelledby="triangulate3d"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> triangulate3D
        
        
      </h2>
    

<ul>
  <li>Here we fix one camera (extrinsic matrix = Identity matrix). Now, we know correspondence points in image1 and image2.</li>
  <li>Therefore we can find the Fundamental matrix based on these point correspondences</li>
</ul>

<p>Now, to estimate the 3D location of these points, we need</p>
<ol>
  <li>Camera matrices (extrinsic*intrinsic) for both cameras M1 and M2</li>
  <li>Image points (x,y) which correspond to each other</li>
  <li><a href="https://www.dropbox.com/sh/r569lhrgq9z4x7l/AACGDws-F4Krdwagm1F3-tnja?dl=0&amp;preview=L17+-+Camera+Models%2C+Pose+Estimation+and+Triangulation.pdf">Some theory</a></li>
</ol>

<p>The above theory is summarized as:
<img src="/images/triangulation_setup.png" alt="" /></p>

<p><img src="/images/triangulation_formula.png" alt="" /></p>

<p>After finding the 3D points, we will reproject them back onto the image and compare them with our original correspondence points (which we either manually selected or got from some keypoint detector like ORB or BRIEF)</p>

<p>The formula for reprojection error in this case is:</p>

<p><img src="/images/3d_reconstruction/1.png" alt="" /></p>
      <h2 id="findm2">
        
        
          <a href="#findm2" class="anchor-heading" aria-labelledby="findm2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> findM2
        
        
      </h2>
    
<p>Previsously we saw that we need an M2 to triangulate, but we don’t have an M2 yet :/.  <br />
However, since our first camera is fixed in 3D we can find the camera matrix M2 of our second camera as:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">camera2</span><span class="p">(</span><span class="n">E</span><span class="p">):</span>
    <span class="n">U</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">svd</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">S</span><span class="p">[:</span><span class="mi">2</span><span class="p">].</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">U</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]])).</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
    <span class="n">U</span><span class="p">,</span><span class="n">S</span><span class="p">,</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">svd</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>
    <span class="n">W</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]])</span>

    <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">det</span><span class="p">(</span><span class="n">U</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">).</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">W</span> <span class="o">=</span> <span class="o">-</span><span class="n">W</span>

    <span class="n">M2s</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">M2s</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">U</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">).</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">].</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]).</span><span class="nb">max</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">M2s</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">U</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">).</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="o">-</span><span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">].</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]).</span><span class="nb">max</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">M2s</span><span class="p">[:,:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">U</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">.</span><span class="n">T</span><span class="p">).</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">].</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]).</span><span class="nb">max</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">M2s</span><span class="p">[:,:,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">U</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">W</span><span class="p">.</span><span class="n">T</span><span class="p">).</span><span class="n">dot</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="o">-</span><span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">].</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">U</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]).</span><span class="nb">max</span><span class="p">()],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">M2s</span>
</code></pre></div></div>

<p><strong>Note: The above function gives three possible values for M2</strong></p>

<p><img src="/images/4cameras.jpg" alt="4 camera orientations" /></p>

<p>Now there are 2 checks we can use to find which is the right camera:</p>
<ul>
  <li>Determinant(Rotation component of M2) = 1 (so that the rotation belongs to SO(3))</li>
  <li>All Z values should be positive (i.e. the 3D point should be in front of both the cameras right?)</li>
</ul>
      <h2 id="combining-the-above-two-functions">
        
        
          <a href="#combining-the-above-two-functions" class="anchor-heading" aria-labelledby="combining-the-above-two-functions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Combining the above two functions
        
        
      </h2>
    

<p>Now we have point correspondences, M1 and 4 M2’s. Therefore we’ll try to triangulate points based on  <br />
the correct criteria for camera orientations. Additionally we’ll also try to minimize reprojection error:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># iterate over M1(fixed) and M2(4 possibilites) by passing them to triangulate
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M2</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="n">M2_current</span> <span class="o">=</span> <span class="n">M2</span><span class="p">[:,:,</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># build the C1 and C2:
</span>        <span class="n">pts_in_3d</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">triangulate</span><span class="p">((</span><span class="n">K1</span> <span class="o">@</span> <span class="n">M1</span><span class="p">),</span> <span class="n">pts1</span><span class="p">,</span> <span class="p">(</span><span class="n">K2</span> <span class="o">@</span> <span class="n">M2_current</span><span class="p">),</span> <span class="n">pts2</span><span class="p">)</span>    
        <span class="k">if</span> <span class="n">err</span> <span class="o">&lt;</span> <span class="n">err_min</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">pts_in_3d</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">"satisfies the error criteria"</span><span class="p">)</span>
            <span class="n">err_min</span> <span class="o">=</span> <span class="n">err</span>
            <span class="n">best_M2_i</span> <span class="o">=</span> <span class="n">i</span>
            <span class="n">best_pts_3d</span> <span class="o">=</span> <span class="n">pts_in_3d</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">best_M2_i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">best_pts_3d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"min err is"</span><span class="p">,</span> <span class="n">err_min</span><span class="p">)</span>
        
        <span class="c1"># return M2, C2, w(3d points), M1, C1
</span>        <span class="k">return</span> <span class="n">M2</span><span class="p">[:,:,</span><span class="n">best_M2_i</span><span class="p">],</span> <span class="p">(</span><span class="n">K2</span> <span class="o">@</span> <span class="n">M2</span><span class="p">[:,:,</span><span class="n">best_M2_i</span><span class="p">]),</span> <span class="n">best_pts_3d</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="p">(</span><span class="n">K1</span> <span class="o">@</span> <span class="n">M1</span><span class="p">)</span> <span class="c1"># last entry is C1
</span></code></pre></div></div>

<p><strong>Finally we all together have our best_3d_points and the correct M2 matrix</strong></p>
      <h1 id="bundle-adjustment">
        
        
          <a href="#bundle-adjustment" class="anchor-heading" aria-labelledby="bundle-adjustment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Bundle Adjustment
        
        
      </h1>
    
<p>We know that the error in the triangulation is basically difference between the projection of a 3D point and the actual point in 2D on the image. Now, we will move around the 3D points slightly and check in which orientation the reprojection error comes to a global minimum.
The formula for the above operation is shown below:</p>

<p><img src="/images/Bundle_formula.png" alt="" /></p>

<p>The process  we will follow now is very code specific. An explanation for only this below code is shown, where we will only be minimizing the rotation and translation (M2 matrix) error.</p>
      <h3 id="high-level-procedure">
        
        
          <a href="#high-level-procedure" class="anchor-heading" aria-labelledby="high-level-procedure"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> High level procedure
        
        
      </h3>
    

<ol>
  <li>Use the 2D point correspondences to find the Fundamental Matrix (along with RANSAC to find the inlier points)</li>
  <li>Use the <strong>inliers</strong> to find our best <strong>F</strong> (fundamental matrix)</li>
  <li>Compute an initial guess for M2 by using our old findM2 function</li>
  <li>Now, the above function would have given us 3D points <strong>(P_init)</strong> and an <strong>M2_init</strong></li>
  <li>Now, we have compiled the following:
    <ul>
      <li>M1 and K1</li>
      <li>M2_init and K2</li>
      <li>F and E <em>(E = (K2.T @ F) @ K1)</em></li>
    </ul>
  </li>
</ol>

<p>Having the above content, we will need to derive our reprojection error. We will do this in the RodriguesResidual function:</p>
      <h4 id="rodriguesresidual-rodriguesresidualx-k1-m1-p1-k2-p2">
        
        
          <a href="#rodriguesresidual-rodriguesresidualx-k1-m1-p1-k2-p2" class="anchor-heading" aria-labelledby="rodriguesresidual-rodriguesresidualx-k1-m1-p1-k2-p2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> RodriguesResidual: <em>rodriguesResidual(x, K1, M1, p1, K2, p2)</em>
        
        
      </h4>
    

<ul>
  <li><strong>x</strong> basically contains the translation and rotation of camera2. We can therefore get M2 from x</li>
  <li>We can find the camera matrices <strong><em>C1 = K1 @ M1</em></strong>, <strong><em>C2 = K2 @ M2</em></strong></li>
</ul>

<p><img src="/images/generic_projection_eq.png" alt="" /></p>

<ul>
  <li>Use the above equation to get p1’ and p2’</li>
  <li>Compare p1’ and p1, p2’ and p2, to get the reprojection error we need in both cameras</li>
</ul>

<p><img src="/images/reproj_error_residuals.png" alt="" /></p>

<p><strong>Now we have a function which will give us reprojection error for a given M2 matrix. Now lets see how we’ll use this reporjection error to optimize our M2</strong></p>
      <h3 id="optimization-of-m2">
        
        
          <a href="#optimization-of-m2" class="anchor-heading" aria-labelledby="optimization-of-m2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Optimization of M2
        
        
      </h3>
    

<p>Now that we have a function which will give us reprojection error for any given M2, lets minimize this error by <strong>moving around our 3D points slightly such that our reprojection error (for all points cumulative) reduces</strong></p>

<p>We do this using the scipy.optimize.minimize function</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># just some repackaging/preprocessing to give x to rodriguesResidual
</span><span class="n">x0</span> <span class="o">=</span> <span class="n">P_init</span><span class="p">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">r2_0</span><span class="p">.</span><span class="n">flatten</span><span class="p">())</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">t2_0</span><span class="p">.</span><span class="n">flatten</span><span class="p">())</span>

<span class="c1"># optimization step
</span><span class="n">x_opt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">scipy</span><span class="p">.</span><span class="n">optimize</span><span class="p">.</span><span class="n">minimze</span><span class="p">(</span><span class="n">rodriguesResidual</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">K1</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">K2</span><span class="p">,</span> <span class="n">p2</span><span class="p">))</span>
</code></pre></div></div>

<p><strong>Finally our x_opt i.e x_optimal will have the correct rotation and translation of camera 2 and the corrected 3D points</strong></p>

        

        

        
        
          <hr>
          <footer>
            

            <p class="text-small text-grey-dk-100 mb-0"></p>

            
              <div class="d-flex mt-2">
                
                
              </div>
            
          </footer>
        

      </div>
    </div>

    
      

      <div class="search-overlay"></div>
    
  </div>
</body>
</html>

